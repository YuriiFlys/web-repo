<section class="w-full max-w-6xl space-y-6" *ngIf="isBrowser">
  <header class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Project Board</p>
      <h1 class="text-3xl font-semibold tracking-tight">
        {{ (project$ | async)?.title || ('Project ' + projectId) }}
      </h1>
    </div>
    <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
      <button
        type="button"
        (click)="openCreate()"
        class="rounded-full bg-slate-900 px-3 py-2 text-xs font-semibold text-white transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-slate-900/30"
      >
        Add task
      </button>
    </div>
  </header>

  <p class="text-sm text-slate-600" *ngIf="loading$ | async">Loading tasks...</p>
  <p class="text-sm font-medium text-rose-600" *ngIf="error$ | async as error">{{ error }}</p>

  <div class="grid gap-5 lg:grid-cols-3">
    <section
      class="rounded-3xl border border-slate-900/10 bg-white/70 p-4 shadow-lg shadow-slate-900/10"
      (drop)="onDrop($event, 'todo')"
      (dragover)="allowDrop($event)"
    >
      <header class="flex items-center justify-between">
        <h2 class="text-sm font-semibold uppercase tracking-widest text-slate-500">To Do</h2>
        <span class="rounded-full bg-slate-900/10 px-2 py-0.5 text-xs font-semibold text-slate-600">
          {{ (todo$ | async)?.length || 0 }}
        </span>
      </header>
      <div class="mt-4 grid gap-3">
        <article
          *ngFor="let task of (todo$ | async)"
          class="group cursor-grab rounded-2xl bg-white p-4 shadow-md shadow-slate-900/10 ring-1 ring-slate-900/5 transition hover:-translate-y-1 hover:shadow-lg"
          draggable="true"
          (dragstart)="onDragStart($event, task)"
          (click)="openDetails(task)"
        >
          <p class="text-sm font-semibold text-slate-900">{{ task.title }}</p>
          <p class="mt-2 line-clamp-2 text-xs text-slate-500" *ngIf="task.description">{{ task.description }}</p>
          <div class="mt-3 flex items-center justify-between text-xs text-slate-500">
            <span>{{ getAssigneeName(task.assigneeId) }}</span>
            <span class="rounded-full bg-slate-900/5 px-2 py-0.5 text-[10px] uppercase tracking-widest">Todo</span>
          </div>
        </article>
      </div>
    </section>

    <section
      class="rounded-3xl border border-slate-900/10 bg-white/70 p-4 shadow-lg shadow-slate-900/10"
      (drop)="onDrop($event, 'in_progress')"
      (dragover)="allowDrop($event)"
    >
      <header class="flex items-center justify-between">
        <h2 class="text-sm font-semibold uppercase tracking-widest text-slate-500">In Progress</h2>
        <span class="rounded-full bg-slate-900/10 px-2 py-0.5 text-xs font-semibold text-slate-600">
          {{ (inProgress$ | async)?.length || 0 }}
        </span>
      </header>
      <div class="mt-4 grid gap-3">
        <article
          *ngFor="let task of (inProgress$ | async)"
          class="group cursor-grab rounded-2xl bg-white p-4 shadow-md shadow-slate-900/10 ring-1 ring-slate-900/5 transition hover:-translate-y-1 hover:shadow-lg"
          draggable="true"
          (dragstart)="onDragStart($event, task)"
          (click)="openDetails(task)"
        >
          <p class="text-sm font-semibold text-slate-900">{{ task.title }}</p>
          <p class="mt-2 line-clamp-2 text-xs text-slate-500" *ngIf="task.description">{{ task.description }}</p>
          <div class="mt-3 flex items-center justify-between text-xs text-slate-500">
            <span>{{ getAssigneeName(task.assigneeId) }}</span>
            <span class="rounded-full bg-slate-900/5 px-2 py-0.5 text-[10px] uppercase tracking-widest">In progress</span>
          </div>
        </article>
      </div>
    </section>

    <section
      class="rounded-3xl border border-slate-900/10 bg-white/70 p-4 shadow-lg shadow-slate-900/10"
      (drop)="onDrop($event, 'done')"
      (dragover)="allowDrop($event)"
    >
      <header class="flex items-center justify-between">
        <h2 class="text-sm font-semibold uppercase tracking-widest text-slate-500">Done</h2>
        <span class="rounded-full bg-slate-900/10 px-2 py-0.5 text-xs font-semibold text-slate-600">
          {{ (done$ | async)?.length || 0 }}
        </span>
      </header>
      <div class="mt-4 grid gap-3">
        <article
          *ngFor="let task of (done$ | async)"
          class="group cursor-grab rounded-2xl bg-white p-4 shadow-md shadow-slate-900/10 ring-1 ring-slate-900/5 transition hover:-translate-y-1 hover:shadow-lg"
          draggable="true"
          (dragstart)="onDragStart($event, task)"
          (click)="openDetails(task)"
        >
          <p class="text-sm font-semibold text-slate-900">{{ task.title }}</p>
          <p class="mt-2 line-clamp-2 text-xs text-slate-500" *ngIf="task.description">{{ task.description }}</p>
          <div class="mt-3 flex items-center justify-between text-xs text-slate-500">
            <span>{{ getAssigneeName(task.assigneeId) }}</span>
            <span class="rounded-full bg-slate-900/5 px-2 py-0.5 text-[10px] uppercase tracking-widest">Done</span>
          </div>
        </article>
      </div>
    </section>
  </div>
</section>

<div
  *ngIf="showModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 px-4"
  (click)="closeModal()"
>
  <div
    class="w-full max-w-2xl rounded-3xl bg-white p-6 shadow-2xl shadow-slate-900/20"
    (click)="$event.stopPropagation()"
  >
  <header class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">
      {{ createMode ? 'Add task' : 'Task details' }}
    </h2>
    <div class="flex items-center gap-2">
      <button
        *ngIf="!createMode && selectedTask"
        type="button"
        class="rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-widest text-rose-600 hover:bg-rose-50"
        (click)="deleteTask(selectedTask)"
      >
        Delete
      </button>
      <button
        type="button"
        class="rounded-full px-3 py-1 text-sm font-semibold text-slate-500 hover:bg-slate-100"
        (click)="closeModal()"
      >
        Close
      </button>
    </div>
  </header>

    <div class="mt-4 grid gap-4" *ngIf="createMode">
      <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest text-slate-500">
        Title
        <input
          type="text"
          name="newTitle"
          [(ngModel)]="newTitle"
          class="rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm font-normal text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
        />
      </label>

      <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest text-slate-500">
        Description
        <textarea
          name="newDescription"
          [(ngModel)]="newDescription"
          rows="4"
          class="rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm font-normal text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
        ></textarea>
      </label>

      <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest text-slate-500">
        Assignee
        <select
          name="newAssigneeId"
          [(ngModel)]="newAssigneeId"
          class="rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm font-normal text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
        >
          <option [ngValue]="null">Unassigned</option>
          <option *ngFor="let user of (users$ | async)" [ngValue]="user.id">
            {{ user.name }} ({{ user.email }})
          </option>
        </select>
      </label>

      <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest text-slate-500">
        Status
        <select
          name="newStatus"
          [(ngModel)]="newStatus"
          class="rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm font-normal text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
        >
          <option value="todo">To Do</option>
          <option value="in_progress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </label>

      <div class="flex items-center justify-end gap-2">
        <button
          type="button"
          class="rounded-full border border-slate-900/15 px-4 py-2 text-xs font-semibold text-slate-900 transition hover:bg-slate-900 hover:text-white"
          (click)="closeModal()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-white transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-slate-900/30"
          (click)="createTask()"
        >
          Create
        </button>
      </div>
    </div>

    <div class="mt-4 grid gap-4" *ngIf="!createMode && selectedTask">
      <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest text-slate-500">
        Title
        <input
          type="text"
          [ngModel]="selectedTask.title"
          (ngModelChange)="onFieldChange(selectedTask, 'title', $event)"
          (blur)="flushUpdate(selectedTask, 'title')"
          class="rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm font-normal text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
        />
      </label>

      <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest text-slate-500">
        Description
        <textarea
          rows="5"
          [ngModel]="selectedTask.description"
          (ngModelChange)="onFieldChange(selectedTask, 'description', $event)"
          (blur)="flushUpdate(selectedTask, 'description')"
          class="rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm font-normal text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
        ></textarea>
      </label>

      <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest text-slate-500">
        Status
        <select
          [ngModel]="selectedTask.status"
          (ngModelChange)="onSelectChange(selectedTask, 'status', $event)"
          class="rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm font-normal text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
        >
          <option value="todo">To Do</option>
          <option value="in_progress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </label>

      <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-widest text-slate-500">
        Assignee
        <select
          [ngModel]="selectedTask.assigneeId"
          (ngModelChange)="onSelectChange(selectedTask, 'assigneeId', $event)"
          class="rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm font-normal text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
        >
          <option [ngValue]="null">Unassigned</option>
          <option *ngFor="let user of (users$ | async)" [ngValue]="user.id">
            {{ user.name }} ({{ user.email }})
          </option>
        </select>
      </label>

      <div class="rounded-2xl border border-slate-900/10 bg-slate-50/70 p-4">
        <h3 class="text-xs font-semibold uppercase tracking-widest text-slate-500">Comments</h3>
        <div class="mt-3 grid gap-3">
          <div
            *ngFor="let comment of (comments$ | async)"
            class="rounded-xl bg-white p-3 text-sm shadow-sm shadow-slate-900/5"
          >
            <div class="flex items-center justify-between">
              <p class="text-xs font-semibold text-slate-600">{{ comment.author }}</p>
              <div class="flex items-center gap-2">
                <span class="text-[10px] text-slate-400">
                  {{ comment.createdAt | date: 'short' }}
                </span>
                <button
                  type="button"
                  class="rounded-full px-2 py-1 text-[10px] font-semibold text-slate-500 hover:bg-slate-100"
                  (click)="deleteComment(comment)"
                >
                  Delete
                </button>
              </div>
            </div>
            <p class="mt-1 text-sm text-slate-900">{{ comment.text }}</p>
          </div>
          <p class="text-xs text-slate-400" *ngIf="(comments$ | async)?.length === 0">
            No comments yet.
          </p>
        </div>

        <div class="mt-4 grid gap-2">
          <textarea
            rows="3"
            [(ngModel)]="newComment"
            placeholder="Write a comment..."
            class="w-full rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-sm text-slate-900 focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/20"
          ></textarea>
          <div class="flex justify-end">
            <button
              type="button"
              (click)="addComment()"
              class="rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-white transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-slate-900/30"
            >
              Add comment
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
